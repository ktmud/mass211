---
title: 'Mass 211 Analysis: the Big Picture'
author: "Jesse Yang"
date: '`r Sys.Date()`'
output:
  tufte::tufte_html:
    tufte_variant: envisioned
    #toc: true
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
link-citations: yes
subtitle: Current Landscape of Human Service Demands in Massachusetts
bibliography: skeleton.bib

---

```{r setup, include=FALSE}
library(tufte)
# invalidate cache when the tufte version changes
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE, warning = FALSE,
  tidy = FALSE, cache.extra = packageVersion('tufte')
)
options(htmltools.dir.version = FALSE)
```

<style>
.sankey-caption {
  width: 90%;
  border: 0;
  font-size: 10pt;
  margin-top: 10px;
}
.sankey-caption td {
  padding-right: 10px;
}
.fullwidth-table table {
  width: 90%;
}
</style>

# Introduction

This report is a rough analysis of all the 211 calls made between _Feb 25, 2016_, and _Feb 9, 2017_^[If I understood the data correctly, the new system is still in testing before May 2016, which was when calls started steadily coming in.]. All the numbers and facts are for the whole time span, i.e., they are about the whole landscape of human service needs reached the Mass 211 system in a roughly 10 month period.

# Key Findings

- The majority of 211 users are first-time callers referred by human service agencies.
- Nearly half of the callers were given more than one referral.
- EEC Applications and status checks are not only the highest volume of calls but also the most time-consuming.
- Both race and income are contributing factors to 211 demands. Low-income non-white people use 211 more than others, but when at the same income level, white people is slightly more likely to use 211 than other races.
- Most of the popular service categories correlate with each other, i.e. a neighborhood in high demand of one service is often in high demand of another.

# Drilling Down

## The flow

```{r, fig.fullwidth=TRUE, fig.width=10, caption="Hello"}
source("./src/sankey.R")

sankeyNetwork(
  Links = sk.links,
  Nodes = sk.nodes,
  Source = "source",
  Target = "target",
  Value = "value",
  NodeID = "name",
  linkOpacity = 0.08,
  colourScale = "d3.scaleOrdinal(d3.schemeCategory10)",
  units = "calls",
  margin = list(left = 0, right = 0, top = 0, bottom = 0),
  fontSize = 10,
  nodePadding = 9,
  nodeWidth = 40
)
``` 

<table class="sankey-caption">
<colgroup>
  <col width="27%">
  <col width="21%">
  <col width="25%">
  <col>
</col>
<tr>
  <td>Have you used Mass211 before?</td>
  <td>How did you hear of Mass211?</td>
  <td align="right">AIRS I&R Need Category</td>
  <td align="right">Referrals Made</td>
</tr>
</table>

Above graph shows where the calls were coming from and where the callers were referred to. The majority of them are from first-time callers referred by human service agencies. `Housing` and `Income Support/Assistance` are the two most inquired issues.^[Most `Income Support/Assistance` requests are about the Early Education and Care program (see below).]

## Calls with multiple purposes

About one-third of all calls had more than one Taxonomy term, and more than 47% callers were given multiple referrals.

```{r}
count.call.cats5 %>%
  filter(str_detect(cats, " \\|\\| ")) %>%
  head(10) %>%
  mutate(
    cats = str_replace_all(cats, "\\|\\|", "<br> &nbsp; Â· "),
    p = round((n / n.call.with.cat) * 100, 2)
  ) %>%
  knitr::kable(
    .,
    caption = "Top 10 Level 5 Taxonomy term combinations",
    col.names = c("Categories", "Num. of Calls", "% of all calls")
  )
```

The most common case of multiple purpose calls were those asking for child care assistance programs, then information regarding child care providers (child care centers or early start sites) were also provided.

Another common case is people making complaints about utility companies while seeking financial assistance in utility payment.

## Calls with single purpose

There are many 'useless' calls in this category.

```{r}
count.call.cats5 %>%
  filter(!str_detect(cats, "\\|\\|")) %>%
  head(10) %>%
  mutate(
    p = round((n / n.call.with.cat) * 100, 2)
  ) %>%
  knitr::kable(
    .,
    caption = "Top 10 Level 5 Taxonomy terms for single purpose call",
    col.names = c("Taxonomy Term", "Num. of Calls", "% of all calls")
  )
```

Child care related calls took the largest portion of the caseload, not only because that Mass 211 has a unique collaboration with Massachussets Department of [Early Education and Care](http://www.mass.gov/edu/birth-grade-12/early-education-and-care/) (EEC) ^[I have found no other states are having the same high-volume of calls related to child care.], but also because some parents frequently called to check their enrollment application for EEC subsidies. ^[About 20% of child care related calls were explicitly marked as status check.] It seems we may need to better inform parents with the expected processing time, if there indeed exists an expectation.

"211 Systems" are mostly border-line-crossing calls from neighboring states; "Directory Assistance" are those intended for 411. They both seem unavoidable.

Putting these categories aside, the most frequently inquired human services are _EEC Applications_, _Homeless Shelter/Rent Assistance_, _Electricity_, and _Food_.

```{r, fig.width=4, fig.height=3, fig.retina=2, fig.margin=TRUE}
library(ggplot2)

avg.call.length <- mean(icalls$call.length, na.rm = TRUE)
  
icalls %>%
  filter(call.length < 60) %>%
  # revert to original call.length for histogram plotting
  ggplot(aes(x = call.length - 0.5, y = ..density..)) +
    geom_histogram(binwidth = 1) +
  labs(title = "Histogram of call length (all calls)",
       x = "Call length (minute)",
       y = "Density") +
  theme_minimal() +
  theme(
    plot.background = element_rect(fill = "#fefefe", color = "#fefefe"),
    axis.text = element_text(family = "Avenir Next", size = 8),
    axis.title = element_text(family = "Avenir Next", size = 10),
    plot.title = element_text(family = "Avenir Next"))
```

## Call length

Average call length of all calls is `r round(avg.call.length, 1)` minutes. Most calls (75%) finish within 10 minutes, 95% of them finish within 20 minutes. Some took as long as 40 minutes or more, but those were rare cases and often involved interpretation services (the caller didn't speak English).

```{r}
avg.call.length2 <- mcalls %>%
  filter(!str_detect(cat4.name, "(211|311|Directory Assistance)")) %>%
  distinct(id, .keep_all = TRUE) %>%
  summarize(cl = mean(call.length)) %>%
  unlist()
```

When removed undesired calls (211 Systems and Directory Assistance), which normally end fast, the average call length becomes `r round(avg.call.length2, 1)` minutes.

```{r}
summary(icalls$call.length) %>%
  broom::tidy() %>%
  knitr::kable(caption = "Mean, median and quantiles of call length")
```

If taking call length into consideration, the list of top categories by caseload would be different. Following are the average call length and number of calls aggregated to the Level 5 Taxonomy term.

```{r}
mcalls.cats.summary %>% head(10) %>%
  select(cat.name, call.length.mean, n.calls, min.per.day) %>%
  knitr::kable(
    digits = 2,
    caption = "The most time-consuming calls",
    col.names = c("Taxonomy Term",
                  "Avg. call length",
                  "Num of calls",
                  "Minutes per day")
  )
```

Note that for calls with multiple purposes, their call lengths are evenly divided for each purpose.

```{r fig.fullwidth, fig.width=10, fig.height=4}
mcalls.treemap %>% d3tree2(rootname = "Taxonomy")
```

```{r, eval = FALSE}
# quantile(icalls$call.length, probs = c(0.8, 0.9, .95))
mcalls %>%
  filter(
    str_detect(
      cat5.name,
      "Child Care"
    ),
    str_detect(
      comment,
      regex("(status check|check status|^ *status *$)",
            ignore_case = TRUE))
  ) %>%
  distinct(id, .keep_all = TRUE) %>%
  summarize(
    n = n(),
    cl = mean(call.length)
  )
```

Use above interactive treemap to explore the average total time consumption per day for each category. Click on the tiles to enter a subcategory, then click on the title bar at the top to go back.

## Geographic Distribution

Since most of the 211 services are about providing help to needy families and individuals, the geographic distribution of 211 calls strongly correlates with the income level of a region.

```{r, fig.width=5.9, fig.height=3}
library(leaflet)

pal <- colorNumeric("viridis", NULL)

leaflet(zip.geo.simple) %>%
  setView(-71.1, 42, zoom = 7) %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    data = county.geo,
    smoothFactor = 0.3,
    weight = 1,
    color = "#333333",
    opacity = 0.7,
    fillOpacity = 0.8,
    fillColor = ~pal(log(p.call)),
    label = ~str_c(
      county, ": ", formatC(p.call, digits = 2, big.mark = ",")
    ),
    highlightOptions = highlightOptions(opacity = 1, color = "#ffffff"),
    group = "County"
  ) %>%
  addPolygons(
    weight = 0.5, opacity = 0.1, color = "#333333",
    smoothFactor = 0.3, fillOpacity = .9,
    fillColor = ~pal(log(p.call)),
    label = ~str_c(
      zip, " ", pa_name, ": ", formatC(p.call, digits = 2, big.mark = ",")
    ),
    highlightOptions = highlightOptions(
      opacity = .7, color = "#ffffff", bringToFront = TRUE
    ),
    group = "ZIP Code"
  ) %>%
  addLayersControl(
    overlayGroups = c("County", "ZIP Code"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  addLegend(
    "bottomright",
    pal = pal,
    values = ~log(p.call),
    opacity = 0.7,
    # use log for color scales, but change it back for legen values
    labFormat = labelFormat(
      transform = function(x) round(exp(x), 1)),
    title = "calls/1k pop"
  )
```

A multiple linear regression was calculated at the zip code level to predict the number of calls per 1,000 residents based on their income, race, and education level.

The variables chosen are percentages of people who completed at least a Bachelor's degree (`education_bachelor`), percentages of white people (`race_white`), and median house income measured in 1,000 US dollars (`income`). An interaction term `race_white:income` is also added to reveal interactions between the effects of house income and race.

```{r, results='hide'}
fit <- lm(p.call ~
            AtLeastBachelor +
            White * MedHouseIncome,
          count.zip)
fit.output <- stargazer::stargazer(
  fit, type = "html",
  dep.var.labels = "Number of calls per 1,000 people",
  covariate.labels =
    c("Education: Bachelor and Above (%)",
      "Race: White (%)",
      "Median House Income (1K USD)",
      "White:MedianHouseIncome"),
  digits = 3
)
```
```{r, results='asis', fig.cap="Multiple Regression"}
fit.coef <- coef(fit) %>% round(3)
fit.output %>% str_replace_all("\\*", "&ast;") %>%
  str_c(collapse = "\n") %>%
  cat()
```

A significant regression equation was found (F(4, 472) = 121.11, p < 0.000), with a $R^2$ of 0.502. 

The predicted number of calls per 1,000 people during a 10-month period is equal to
_`r fit.coef[1]` - `r abs(fit.coef[2])` (education_bachelor) - `r abs(fit.coef[3])` (race_white) - `r abs(fit.coef[4])` (income) + `r fit.coef[5]` (race_white:income)_. 

The number of calls would decrease `r abs(fit.coef[2])` per 1 percent increase in people with a Bachelor's degree, `r abs(fit.coef[3])` per 1 percent increase in white residents, and `r abs(fit.coef[4])` per $1,000 increase in median house income.

For different races (white and non-white), the effect of income may differ, but the difference is small (only `r abs(fit.coef[5])`)--at the same income level, white people is slightly more likely to call 211 than other races.

## Concomitant requests

A call may naturally have multiple purposes, but does a call for certain service predict the coming of other types of needs?

To answer this question, we can check the concordance of need categories, i.e. the correlation between volumes of calls in different categories at a given region.

```{r}
cor.res <- cor.test(~ Housing + `Income Support`,
                    zip.cat.count %>% filter(Housing > 0 & `Income Support` > 0),
                    method = "kendall")
cor.res.tau <- cor.res$estimate %>% round(3)
```

Take the most requested two service categories for example, zip code areas with higher demands for _Income Support (Child Care Assistance)_ almost always have a high demand for _Housing Assistance_ (Kendall's tau coefficients $r_{\tau}$ = `r cor.res.tau`, p < 0.000).

The same strong correlation can be found at most AIRS Need Category pairs.

```{r}
cats <- unique(mmcalls$airs.cat)

cat.corr <-
  sapply(cats, function(x) {
    sapply(cats, function(y) {
      if (x == y) {
        # 0 means no relation, -1 means disagreement is perfect,
        # 1 mean perfectly agrees
        return("0:0")
      }
      f <- formula(sprintf("~  \`%s\` + \`%s\`", x, y))
      dat <- zip.cat.count %>%
        .[.[[x]] > 0 & .[[y]] > 0, ]
      ct <- cor.test(formula = f, data = dat, method = "kendall")
      str_c(ct$estimate, ":", ct$p.value)
    })
  })
cat.corr <- cat.corr %>% as.data.frame()
cat.corr$key <- row.names(cat.corr) %>% str_replace(".tau", "")
cat.corr <- cat.corr %>% gather(key)
colnames(cat.corr) <- c("x", "y", "value")
cat.corr %<>% as_tibble() %>%
  separate(value, into = c("tau", "p.value"), sep = ":", convert = TRUE)
```

```{r, fig.wigth=5.9, fig.height=5, fig.cap="Concordance between service categories"}
cat.corr %>%
  filter(
    p.value < 0.01
  ) %>%
  ggplot(
    aes(
      x = x,
      y = factor(y, unique(y) %>% sort(decreasing = TRUE))
    )
  ) +
  geom_tile(aes(
    fill = tau
  )) +
  scale_fill_gradient(low = "white",  high = "steelblue") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0), position = "right") +
  theme(
    legend.position = "none",
    axis.ticks = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
  ) +
  labs(x = "", y = "")
```

This graph shows Kendall's tau coefficients for each pair of AIRS Problem/Need categories. The darker the blue, the more in agreement the two are. Transparent tiles represent insignificant results, mostly because of low call volume. To minimize bias, zip codes with no call in one of the categories were removed before calculation.

The most obvious pairs are _Art/Culture/Recreation + Clothing/Personal/Household Needs_, _Employment + Volunteers/Donations_, _Disaster Services + Volunteers/Donations_, and _Housing + Income Support_.

It is not immediately clear whether calls of different categories are from the same group of people or not.

# Notes

## Data Treatment

This report is based on the iCarol reports generated on Feb 9, 2017. The data were manually cleaned and transformed, with a few noteworthy controls:

1. Only regular Mass 211 calls are used^[ReportVersion = Mass 211]. "Call2Talk", "Runaway Form", and "Mass 211 Text", "Mass 211 Chat" were all ignored, the reason being that their number are small and they often contain incomplete or unique data fields, which means some separate analyses are more appropriate.
2. Different data fields about the same information were merged into one. For example, "Data Collection - How did you Learn about Mass211" and "Caller Data - How Heard about Call2Talk?" are treated as one field.
3. Some missing records of AIRS Problem/Needs categories were completed with inferences from the Taxonomy. E.g., "Target People -> Low Income" was mapped to "Income Support/Assistance".
4. All call length values were increased by 0.4 minutes, because they were zero-based and adding zeros up will introduce bias for the "minutes per day" metric.


## Categorization

[The Taxonomy](http://www.airs.org/i4a/pages/index.cfm?pageid=3386) provides a comprehensive and logical structure for human services, but is not suitable for high-level analyses--the end-level terms are too granular (there are 830 of them), and the upper levels too broad and not self-explanatory.

The [AIRS: I&R Problem/Needs National Categories](https://www.acallforhelp.info/cms6/files/os007/p46/AIRS%20ProblemNeeds%20definitions%202012.pdf)^[The linked document is outdated. It contains only 16 categories, but AIRS has [split](http://www.icarol.com/changes-to-airs-problemsneeds-categories/) "Housing/Utility" into two separate categories in 2014, making it 17 categories in our case.] as seen in the `MetUnmet` report is a better candidate for reporting, and was used in [the flow chart](#the-flow) at the beginning fo this document, but they are also not revealing enough. For instance, "Income Support" does not reveal the fact that the majority need is Early Education and Care.

That is why I used AIRS Neet Categories for general analaysis, but Level 5 Taxonomy terms to reveal more details in call purposes. Another solution is to create a flat, topic-based categorization method that aligns with the unique demands Massachusetts constituents. Curating such a list is a time-consuming process and would need vigorous validation. 

# Next Steps

This report presents the big picture of the state's human service needs of the past year and created graphs and tools to explore some of the basic characteristics of the data.

The next step is to cross-validate with more data sources and start analyzing other data fields such as age, sex, and family characteristics.

But before that, building a simple and robust typology is yet still an unresolved challenge. I tried some name matching with Regular Expressions, but it did not work well for all cases.

However, if we are satisfied with current big picture presentation, we may also choose to dive into specific topics immediately. That is, to isolate calls related to a certain topic, for instance, people with mental health and substance abuse issues, then conduct comprehensive analysis in caller profiling, longitudinal trend, etc. 

# Questions

1. Any comment in this big picture analysis? What else would you like to see?
1. Are agency resources categorized in any way in the system? E.g., being tagged as Police, Municipality Service, Government Aide Program, Volunteer and Charity, Hospital, Shelters, etc. In the Flow diagram, I grouped the agencies by keywords in the names. Had we an official categorization method, the "Other Agency" chunk would be much smaller.
2. Is the typology used by 211counts.org known to you? Did they develop the whole thing by themselves or is it yet another shared categorization system just like the Taxonomy and AIRS Problem/Need Categories?
3. Did the merging of Call2Talk and 211 change the way you work or how you keep logs of these calls?
4. Some Call2Talk calls were referred to Call2Talk (ReferralsMade = Call2Talk). Is it just redundant data, or does it have a special meaning?
5. What's the password of http://mass211.org/mass-211-stats/ ?


```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(c('base', 'rmarkdown'), file = 'skeleton.bib')
```

```{r, eval=FALSE}
rmarkdown::render("1-Big Picture.Rmd")
```